name: Build Mikrotik RSC

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Ежедневно в 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      cnt: 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch latest hosts
        run: curl -s https://raw.githubusercontent.com/AntiZapret/antizapret-hosts/master/hosts > hosts

      - name: Fetch previous hosts snapshot
        run: cp hosts old-hosts || true

      - name: Compare hosts
        run: |
          if cmp -s hosts old-hosts; then
            echo "::notice ::No changes in AntiZapret hosts, skipping update"
            exit 0
          fi

      - name: Generate dns-static.rsc
        run: bash scripts/generate-rsc.sh


      - name: Commit & Tag
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add mikrotik/dns-static.rsc hosts
          git commit -m "Rebuild Mikrotik RSC: $cnt entries"
          DATE=$(date +'%Y%m%d')
          TAG="v$DATE"
          CHANGELOG="Автоматическая сборка MikroTik RSC\nДобавлено $cnt записей"
          git tag $TAG
          git push origin main --tags

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +'%Y%m%d')
          TAG="v$DATE"
          DOMAINS=$(cat mikrotik/new-domains.txt | sed 's/^/• /')
          CHANGELOG="Автоматическая сборка MikroTik RSC\nДобавлено $cnt записей\n\n$DOMAINS"

          gh release create $TAG mikrotik/dns-static.rsc \
            --title "DNS Static $TAG" \
            --notes "$CHANGELOG"

