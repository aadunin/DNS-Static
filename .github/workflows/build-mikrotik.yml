name: Build Mikrotik RSC

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *" # каждый день в 00:00 UTC
  workflow_dispatch:

jobs:
  build:
    name: Build Mikrotik RSC
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Fetch latest hosts
        run: |
          curl -sSL -o hosts https://raw.githubusercontent.com/pumPCin/AntiZapret/main/hosts

      - name: Fetch previous hosts snapshot
        run: |
          curl -sSL -o old-hosts https://raw.githubusercontent.com/${{ github.repository }}/main/hosts || touch old-hosts

      - name: Compare hosts
        id: cmp
        shell: bash
        run: |
          if cmp -s hosts old-hosts; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "::notice ::No changes in AntiZapret hosts, skipping update"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate dns-static.rsc
        if: steps.cmp.outputs.changed == 'true'
        id: gen
        shell: bash
        run: |
          mkdir -p mikrotik
          echo '/ip dns static remove [find address-list="autohost"]' > mikrotik/dns-static.rsc

          # Собираем пары и сортируем для детерминизма
          tmp_pairs="$(mktemp)"
          grep -Ev '^(#|$)' hosts | while read -r ip rest; do
            for d in $rest; do
              if [[ "$ip" == "127.0.0.1" && ( "$d" == "local" || "$d" == "localhost" || "$d" == "localhost.localdomain" ) ]]; then
                continue
              fi
              if [[ "$ip" == "255.255.255.255" && "$d" == "broadcasthost" ]]; then
                continue
              fi
              [[ "$ip" == "0.0.0.0" ]] && ip_addr="192.0.2.1" || ip_addr="$ip"
              printf "%s %s\n" "$ip_addr" "$d" >> "$tmp_pairs"
            done
          done

          # Убираем дубликаты и сортируем
          cnt=0
          while read -r ip_addr d; do
            echo "/ip dns static add name=$d address=$ip_addr ttl=1d address-list=autohost" >> mikrotik/dns-static.rsc
            cnt=$((cnt+1))
          done < <(sort -u "$tmp_pairs")

          echo "/log info \"[update-hosts] Added $cnt entries\"" >> mikrotik/dns-static.rsc
          echo ":: Generated $cnt unique entries"
          echo "count=$cnt" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.cmp.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot/update-mikrotik-rsc
          title: "Rebuild Mikrotik RSC: ${{ steps.gen.outputs.count }} entries"
          commit-message: "Rebuild Mikrotik RSC: ${{ steps.gen.outputs.count }} entries"
          body: |
            Auto-generated update from AntiZapret.
            Entries: ${{ steps.gen.outputs.count }}
          add-paths: |
            mikrotik/dns-static.rsc
            hosts
          delete-branch: true
