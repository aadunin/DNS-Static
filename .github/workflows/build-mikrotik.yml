name: Build Mikrotik RSC

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl gh

      - name: Download hosts
        run: |
          curl -sSL \
            https://raw.githubusercontent.com/AntiZapret/antizapret-hosts/master/hosts \
            -o hosts

      - name: Verify hosts download
        run: |
          if [[ ! -s hosts ]]; then
            echo "ERROR: hosts file is missing or empty" >&2
            exit 1
          fi

      - name: Generate RSC
        run: bash -xe scripts/generate-rsc.sh

      - name: Commit & Tag
        if: env.cnt != '0'
        run: |
          DATE=$(date +'%Y%m%d')
          TAG="v$DATE"
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release (no changes)
        if: env.cnt == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v$(date +'%Y%m%d')"
          gh release create "$TAG" \
            --title "DNS Static $TAG" \
            --notes "Нет новых записей. RSC-файл не изменился."

      - name: Create GitHub Release with RSC
        if: env.cnt != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +'%Y%m%d')
          TAG="v$DATE"
          DOMAINS=$(sed 's/^/• /' mikrotik/new-domains.txt)
          CHANGELOG="Автоматическая сборка MikroTik RSC\nДобавлено $cnt записей\n\n$DOMAINS"
          gh release create "$TAG" mikrotik/dns-static.rsc \
            --title "DNS Static $TAG" \
            --notes "$CHANGELOG"
