name: Build Mikrotik RSC

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *" # каждый день в 00:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:

    # 1) Клонируем репозиторий
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        persist-credentials: false

    # 2) Скачиваем свежий hosts из AntiZapret
    - name: Fetch latest hosts
      run: |
        curl -sSL -o hosts https://raw.githubusercontent.com/pumPCin/AntiZapret/main/hosts

    # 3) Скачиваем предыдущий snapshot из своего репо
    - name: Fetch previous hosts snapshot
      run: |
        curl -sSL -o old-hosts https://raw.githubusercontent.com/aadunin/DNS-Static/main/hosts || touch old-hosts

    # 4) Сравниваем и прерываем workflow, если изменений нет
    - name: Compare hosts
      run: |
        if cmp -s hosts old-hosts; then
          echo "::notice ::No changes in AntiZapret hosts, skipping update"
          exit 0
        fi

    # 5) Генерируем mikrotik/dns-static.rsc
    - name: Generate dns-static.rsc
      run: |
        mkdir -p mikrotik
        echo "/ip dns static remove [find address-list=\"autohost\"]" > mikrotik/dns-static.rsc
        declare -A seen
        cnt=0
        while read -r ip rest; do
          for d in $rest; do
            if [[ "$ip" == "127.0.0.1" && ( "$d" == "local" || "$d" == "localhost" || "$d" == "localhost.localdomain" ) ]]; then continue; fi
            if [[ "$ip" == "255.255.255.255" && "$d" == "broadcasthost" ]]; then continue; fi
            if [[ "$ip" == "0.0.0.0" ]]; then ip_addr="192.0.2.1"; else ip_addr="$ip"; fi
            key="$ip_addr|$d"
            if [[ -n "${seen[$key]}" ]]; then continue; fi
            seen[$key]=1
            echo "/ip dns static add name=$d address=$ip_addr ttl=1d address-list=autohost" >> mikrotik/dns-static.rsc
            cnt=$((cnt+1))
          done
        done < <(grep -Ev '^(#|$)' hosts)
        echo "/log info \"[update-hosts] Added $cnt entries\"" >> mikrotik/dns-static.rsc
        echo ":: Generated $cnt unique entries"

    # 6) Коммитим и пушим .rsc и новый hosts
    - name: Commit & Push dns-static.rsc and hosts snapshot
      if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add mikrotik/dns-static.rsc hosts
        git diff --quiet --cached || git commit -m "Rebuild Mikrotik RSC: $cnt entries"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main
